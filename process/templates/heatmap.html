{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>D3.js with Django</title>
    <link rel="stylesheet" href="{% static 'styles/styles.css' %}">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
<div class="vertical-flex">
    <div>
        <svg id="protein_heatmap" width="1000" height="450"></svg>
    </div>
    <div class="legend">
        {% if accession_number %}
            Abundances for protein {{ accession_number }} in {{ project.full_name }}
        {% else %}
            Abundances for relevant proteins for {{ project.full_name }}
        {% endif %}
    </div>
    <div>
        <svg id="phospho_heatmap" width="1000" height="450"></svg>
    </div>
    <div class="legend">
        {% if accession_number %}
            Abundances for phosphorylation sites for protein {{ accession_number }} in {{ project.full_name }}
        {% else %}
            Abundances for CDK1 phosphorylation sites for {{ project.full_name }}
        {% endif %}
    </div>
</div>

{{ protein_genes|json_script:"protein-genes" }}
{{ protein_readings_data|json_script:"protein-readings-data" }}
{{ protein_reading_max|json_script:"protein-reading-max" }}
{{ phospho_phosphosites|json_script:"phospho-phosphosites" }}
{{ phospho_readings_data|json_script:"phospho-readings-data" }}
{{ phospho_reading_max|json_script:"phospho-reading-max" }}
{{ samples_data|json_script:"samples-data" }}

<script>
    const protein_genes = JSON.parse(document.getElementById('protein-genes').textContent);
    const protein_expression_matrix = JSON.parse(document.getElementById('protein-readings-data').textContent);
    const protein_reading_max = JSON.parse(document.getElementById('protein-reading-max').textContent);
    const phospho_phosphosites = JSON.parse(document.getElementById('phospho-phosphosites').textContent);
    const phospho_expression_matrix = JSON.parse(document.getElementById('phospho-readings-data').textContent);
    const phospho_reading_max = JSON.parse(document.getElementById('phospho-reading-max').textContent);
    const samples = JSON.parse(document.getElementById('samples-data').textContent);

    heatmap("#protein_heatmap", protein_genes, protein_expression_matrix, samples, protein_reading_max)
    heatmap("#phospho_heatmap", phospho_phosphosites, phospho_expression_matrix, samples, phospho_reading_max)

    function heatmap(id, genes, expression_matrix, samples, colourRange) {
        const cellSize = 60;
        const margin = { top: 120, right: 50, bottom: 50, left: 200 };

        const svg = d3.select(id)
            .attr("width", margin.left + samples.length * cellSize + margin.right)
            .attr("height", margin.top + genes.length * cellSize + margin.bottom);

        const colorScale = d3.scaleLinear()
            .domain([0, colourRange])
            .range(["white", "#0072B2"]);

        genes.forEach((gene, rowIndex) => {
            samples.forEach((sample, colIndex) => {
                const value = expression_matrix[rowIndex][colIndex];

                svg.append("rect")
                    .attr("x", margin.left + colIndex * cellSize)
                    .attr("y", margin.top + rowIndex * cellSize)
                    .attr("width", cellSize)
                    .attr("height", cellSize)
                    .attr("class", "cell")
                    .attr("fill", value == null || isNaN(value) ? "white" : colorScale(value));
            });
        });

        // Row labels (genes)
        svg.selectAll(".row-label")
            .data(genes)
            .enter()
            .append("text")
            .attr("x", margin.left - 10)
            .attr("y", (d, i) => margin.top + i * cellSize + cellSize / 2)
            .attr("dy", "0.35em")
            .attr("text-anchor", "end")
            .text(d => d);

            svg.selectAll(".col-label")
    .data(samples)
    .enter()
    .append("text")
    .attr("x", (d, i) => margin.left + i * cellSize + cellSize / 2)
    .attr("y", margin.top - 10)
    .attr("text-anchor", "start")
    .attr("transform", (d, i) => {
        const x = margin.left + i * cellSize + cellSize / 2;
        const y = margin.top - 10;
        return `rotate(-90, ${x}, ${y})`;
    })
    .text(d => d);

    const legend_svg = d3.select(id);
    const defs = legend_svg.append("defs");

    // Create linear gradient
    const gradient = defs.append("linearGradient")
      .attr("id", "legend-gradient")
      .attr("x1", "0%")
      .attr("x2", "100%")
      .attr("y1", "0%")
      .attr("y2", "0%");

    // Add color stops
    gradient.append("stop")
      .attr("offset", "0%")
      .attr("stop-color", "#ffffff"); // white (low)

    gradient.append("stop")
      .attr("offset", "100%")
      .attr("stop-color", "#0072B2"); // blue (high)

    // Draw gradient rectangle
    legend_svg.append("rect")
      .attr("x", 400)
      .attr("y", 140 + expression_matrix.length * 60)
      .attr("width", 120)
      .attr("height", 20)
      .style("fill", "url(#legend-gradient)")
      .style("stroke", "black");

    // Add text labels
    legend_svg.append("text")
      .attr("x", 372)
      .attr("y", 153 + expression_matrix.length * 60)
      .attr("text-anchor", "middle")
      .attr("alignment-baseline", "middle")
      .text("Low");

    legend_svg.append("text")
      .attr("x", 547)
      .attr("y", 153 + expression_matrix.length * 60)
      .attr("text-anchor", "middle")
      .attr("alignment-baseline", "middle")
      .text("High");

    }

</script>


</body>
</html>
