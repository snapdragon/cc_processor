{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>D3.js with Django</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .bar {
            fill: steelblue;
        }
        text {
          font-family: "Arial", sans-serif;
          font-size: 18px;
        }
    </style>
</head>
<body>
<svg id="protein_heatmap" width="1000" height="400"></svg>
<svg id="phospho_heatmap" width="1000" height="400"></svg>

{{ protein_genes|json_script:"protein-genes" }}
{{ protein_readings_data|json_script:"protein-readings-data" }}
{{ phospho_phosphosites|json_script:"phospho-phosphosites" }}
{{ phospho_readings_data|json_script:"phospho-readings-data" }}
{{ samples_data|json_script:"samples-data" }}

<script>
    const protein_genes = JSON.parse(document.getElementById('protein-genes').textContent);
    const protein_expressionMatrix = JSON.parse(document.getElementById('protein-readings-data').textContent);
    const phospho_phosphosites = JSON.parse(document.getElementById('phospho-phosphosites').textContent);
    const phospho_expressionMatrix = JSON.parse(document.getElementById('phospho-readings-data').textContent);
    const samples = JSON.parse(document.getElementById('samples-data').textContent);

    heatmap("#protein_heatmap", protein_genes, protein_expressionMatrix, samples, 7000000)
    heatmap("#phospho_heatmap", phospho_phosphosites, phospho_expressionMatrix, samples, 27000000)

    function heatmap(id, genes, expressionMatrix, samples, colourRange) {
        const cellSize = 60;
        const margin = { top: 120, right: 50, bottom: 50, left: 100 };

        const svg = d3.select(id)
            .attr("width", margin.left + samples.length * cellSize + margin.right)
            .attr("height", margin.top + genes.length * cellSize + margin.bottom);

        const colorScale = d3.scaleLinear()
            .domain([0, colourRange])
            .range(["white", "darkblue"]);

        genes.forEach((gene, rowIndex) => {
            samples.forEach((sample, colIndex) => {
                const value = expressionMatrix[rowIndex][colIndex];

                svg.append("rect")
                    .attr("x", margin.left + colIndex * cellSize)
                    .attr("y", margin.top + rowIndex * cellSize)
                    .attr("width", cellSize)
                    .attr("height", cellSize)
                    .attr("class", "cell")
                    .attr("fill", value == null || isNaN(value) ? "white" : colorScale(value));
            });
        });

        // Row labels (genes)
        svg.selectAll(".row-label")
            .data(genes)
            .enter()
            .append("text")
            .attr("x", margin.left - 10)
            .attr("y", (d, i) => margin.top + i * cellSize + cellSize / 2)
            .attr("dy", "0.35em")
            .attr("text-anchor", "end")
            .text(d => d);

            svg.selectAll(".col-label")
    .data(samples)
    .enter()
    .append("text")
    .attr("x", (d, i) => margin.left + i * cellSize + cellSize / 2)
    .attr("y", margin.top - 10)
    .attr("text-anchor", "start") // or "end", depending on desired alignment
    .attr("transform", (d, i) => {
        const x = margin.left + i * cellSize + cellSize / 2;
        const y = margin.top - 10;
        return `rotate(-90, ${x}, ${y})`; // rotate around the label's position
    })
    .text(d => d);
    }

</script>


</body>
</html>
